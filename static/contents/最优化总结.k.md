# 最优化总结

最优化是一门研究函数最值和极值问题的数学学科。本课程要求掌握以下方法，共计9个类型：

| 方法         | 适用问题类型    | 是否有约束 | 凸性    | 说明                                                       |
| ------------ | --------------- | ---------- | ------- | ---------------------------------------------------------- |
| 单纯形法     | 线性规划        | 有约束     | 凸      | 用于求解有约束线性规划问题，全局最优解                     |
| 对偶理论     | 线性规划        | 有约束     | 凸      | 利用对偶问题分析最优性及敏感性，可求界或简化问题           |
| KKT条件      | 非线性规划      | 有约束     | 凸/非凸 | 有约束问题的最优性条件，对凸问题是必要且充分，对非凸仅必要 |
| 拉格朗日对偶 | 非线性/线性规划 | 有约束     | 凸/非凸 | 构造对偶问题，可用于下界估计和优化解的间接求解             |
| 最速下降法   | 非线性规划      | 无约束     | 凸/非凸 | 基于梯度沿最速方向迭代，凸函数可收敛到全局最优             |
| 牛顿法       | 非线性规划      | 无约束     | 凸/非凸 | 利用二阶信息加快收敛，凸函数可收敛到全局最优               |
| 共轭梯度法   | 非线性规划      | 无约束     | 凸      | 对大规模凸二次问题高效，避免直接求逆矩阵                   |
| 外点罚函数法 | 非线性规划      | 有约束     | 凸/非凸 | 将约束问题转化为无约束问题，允许初始点在可行域外           |
| 内点罚函数法 | 非线性规划      | 有约束     | 凸/非凸 | 将约束问题转化为无约束问题，解始终在可行域内，常用于内点法 |

---

## 一、单纯形法

### （1）一般流程

1. 将一般线性规划问题转换为标准形式
2. 选取标准单位矩阵作为基解
3. 计算校验数，校验数都非负则为最优解，否则将最小的校验数对应的变量作为进基变量
4. 计算最小比值，将最小的正数比值对应的变量作为离基变量
5. 调整进基变量矩阵是的构成新单位矩阵
6. 重复迭代计算

### （2）示例

1. 求解问题：

$$
\begin{aligned}

min \quad x_1-2x_2 + x_3 \\
s.t. \quad x_1 +x_2 -2x_3 + x_4 = 10 \\
2x_1 - x_2 + 4x_3 \le 8 \\
-x_1 + 2x_2 - 4x_3 \le 4 \\
x_i \ge 0, j =1,2,3,4
\end{aligned}


$$

2. 化为标准形式：

$$
\begin{aligned}

min \quad x_1-2x_2 + x_3 \\ s.t. \quad x_1 +x_2 -2x_3 + x_4 = 10 \\ 2x_1 - x_2 + 4x_3 + x_5 = 8 \\
-x_1 + 2x_2 - 4x_3 + x_6 =  4 \\ x_i \ge 0, j =1,2,3,4,5,6
\end{aligned}


$$

3. 选取$x_4,x_5,x_6$作为基本解，列出单纯形表：

|  c  |       |  $1$  | $-2$  |  $1$  |  $0$  |  $0$  |  $0$  |           |
| :-: | :---: | :---: | :---: | :---: | :---: | :---: | :---: | :-------: |
|     |  基   | $x_1$ | $x_2$ | $x_3$ | $x_4$ | $x_5$ | $x_6$ | $\bar{b}$ |
| $0$ | $x_4$ |  $1$  |  $1$  | $-2$  |  $1$  |  $0$  |  $0$  |   $10$    |
| $0$ | $x_5$ |  $2$  | $-1$  |  $4$  |  $0$  |  $1$  |  $0$  |    $8$    |
| $0$ | $x_6$ | $-1$  |  $2$  | $-4$  |  $0$  |  $0$  |  $1$  |    $4$    |
|     |  $r$  |  $?$  |  $?$  |  $?$  |  $0$  |  $0$  |  $0$  |           |

4. 计算校验数：

校验数$r_j = c_j - c_bB^{-1}A_j =  c_j - c_bA_j$

|  c  |       |  $1$  |    $-2$     |  $1$  |  $0$  |  $0$  |  $0$  |           |
| :-: | :---: | :---: | :---------: | :---: | :---: | :---: | :---: | :-------: |
|     |  基   | $x_1$ |    $x_2$    | $x_3$ | $x_4$ | $x_5$ | $x_6$ | $\bar{b}$ |
| $0$ | $x_4$ |  $1$  |     $1$     | $-2$  |  $1$  |  $0$  |  $0$  |   $10$    |
| $0$ | $x_5$ |  $2$  |    $-1$     |  $4$  |  $0$  |  $1$  |  $0$  |    $8$    |
| $0$ | $x_6$ | $-1$  | $\boxed{2}$ | $-4$  |  $0$  |  $0$  |  $1$  |    $4$    |
|     |  $r$  |  $1$  |    $-2$     |  $1$  |  $0$  |  $0$  |  $0$  |           |

5. 计算最小比率：

因为$r_2 = -2 \lt 0$，故问题没有达到最优解，计算最小比率：

$$
\theta_k =  \bar{b_k}  / A_{2k}
$$

有

$$
\begin{cases}
\theta_4 = 10 / 1 = 10 \\
\theta_5 = 8 / -1 = -8 \quad \text{（负数不参与）}\\
\theta_6 = 4 / 2 = 2  \quad \text{（正数中最小）}\\
\end{cases}
$$

故$x_2$进基，$x_6$离基，构造新的单纯形表：

|  c   |       |  $1$   | $-2$  |     $1$     |  $0$  |  $0$  |  $0$   |           |
| :--: | :---: | :----: | :---: | :---------: | :---: | :---: | :----: | :-------: |
|      |  基   | $x_1$  | $x_2$ |    $x_3$    | $x_4$ | $x_5$ | $x_6$  | $\bar{b}$ |
| $0$  | $x_4$ | $3/2$  |  $0$  |     $0$     |  $1$  |  $0$  | $-1/2$ |    $8$    |
| $0$  | $x_5$ | $3/2$  |  $0$  | $\boxed{2}$ |  $0$  |  $1$  | $1/2$  |   $10$    |
| $-2$ | $x_2$ | $-1/2$ |  $1$  |    $-2$     |  $0$  |  $0$  | $1/2$  |    $2$    |
|      |  $r$  |  $0$   |  $0$  |    $-3$     |  $0$  |  $0$  |  $1$   |           |

6. 开始下一轮迭代，$x_3$进基，$x_5$离基，构造新的单纯形表：

|  c   |       |  $1$  | $-2$  |  $1$  |  $0$  |  $0$  |  $0$   |           |
| :--: | :---: | :---: | :---: | :---: | :---: | :---: | :----: | :-------: |
|      |  基   | $x_1$ | $x_2$ | $x_3$ | $x_4$ | $x_5$ | $x_6$  | $\bar{b}$ |
| $0$  | $x_4$ | $3/2$ |  $0$  |  $0$  |  $1$  |  $0$  | $-1/2$ |    $8$    |
| $1$  | $x_3$ | $3/4$ |  $0$  |  $1$  |  $0$  | $1/2$ | $1/4$  |    $5$    |
| $-2$ | $x_2$ |  $1$  |  $1$  |  $0$  |  $0$  |  $1$  |  $1$   |   $12$    |
|      |  $r$  | $9/4$ |  $0$  |  $0$  |  $0$  | $3/2$ | $7/4$  |           |

此时所有校验数都大于零，取得最优解，$\bar{x} = (0,12,5,8)$,最优值为$-19$

---

## 二、对偶理论

### （1）一般流程

1. 原最小化问题转为最大化问题
2. 原每个约束条件都对应一个新决策变量
3. 原约束条件的右侧项作为目标函数的系数矩阵
4. 原约束条件矩阵转置成新的约束条件矩阵
5. 原目标函数的系数矩阵作为新约束条件的右侧项
6. 原约束条件的方向决定新决策变量的方向（相同）
7. 原决策变量的方向决定新约束条件的方向（相反）

### （2）示例

1. 求以下问题的对偶问题：

$$
\begin{aligned}

min \quad x_1 - x_2 \\
s.t. \quad x_1 +x_2 \ge 5\\
x_1 - 2x_2 \ge 1\\
x_1,x_2 \ge 0
\end{aligned}


$$

2. 计算求得：

$$
\begin{aligned}

min \quad 5w_1 + w_2 \\
s.t. \quad w_1 +w_2 \le 1\\
w_1 - 2w_2 \le -1\\
w_1,w_2 \ge 0
\end{aligned}


$$

---

## 三、KKT条件

根据上表我们看到$KKT$条件适用场景非常多，但是在不同条件下有性质并不相同，对于无约束问题没必要使用该方法：

| 类型           | 性质     | 描述                                                                              |
| -------------- | -------- | --------------------------------------------------------------------------------- |
| 有约束凸优化   | 充要条件 | 构建拉格朗日函数，是全局最小值                                                    |
| 有约束非凸优化 | 必要条件 | 构建拉格朗日函数，拉格朗日函数关于$x$在可行方向上的海森矩阵是正定，才是局部极小值 |

### （1）一般流程

1. 标准化约束条件，统一成$g_i(x) \ge 0$的形式（$g_i(x)$要求是凹函数）
2. 构建对应拉格朗日函数
   $\mathcal{L}(x, w, v)= f(x) - \sum_{i=1}^m w_i g_i(x)- \sum_{j=1}^p v_j h_j(x)$
3. 构建拉格朗日函数约束条件矩阵
4. 求得KKT点
5. 使用拉格朗日函数二阶信息进行校验

### （2）有约束凸规划示例

1. 求解问题：

$$
\begin{aligned}
min \quad f(x) = (x_1-1)^2 + (x_2-1)^2 \\
s.t. \quad -x_1 -x_2 + 2 \ge 0\\
x_2 - x_1 = 0 \\
x_1,x_2 \ge 0
\end{aligned}
$$

2. 计算拉格朗日函数及其梯度：

$$
L(x,w,v) = (x_1 - 1)^2 + (x_2 -1)^2 - (-x_1 - x_2 + 2)w_1 - w_2x_1 - x_2w_3 - (-x_2 - x_1 - 1)v
$$

$$
\nabla_x L(x,w,v) = \begin{cases}
2(x_1-1) + w_1 - w_2 +v \\
2(x_2-1) + w_1 - w_3 -v
\end{cases}
$$

3. 列出所有约束条件（$KKT条件$）：

- 拉格朗日函数梯度为零

  $$
  \begin{cases}
  2(x_1-1) + w_1 - w_2 +v = 0 \\
  2(x_2-1) + w_1 - w_3 -v = 0 \\
  \end{cases}
  $$

- 原约束条件成立
  $$
  \begin{cases}
  -x_1 -x_2 + 2 \ge 0,\\
  x_2 - x_1 = 0, \\
  x_1 \ge 0, \\
  x_2 \ge 0, \\
  \end{cases}
  $$
- 互补松弛条件成立

  $$
  \begin{cases}
  w_1(-x_1 -x_2 + 2) = 0, \\
  w_2x_1 = 0, \\
  w_3x_2 = 0,\\
  \end{cases}
  $$

- 对偶问题决策变量方向成立

$$
\begin{cases}
w_1 \ge 0,\\
w_2 \ge 0,\\
w_3 \ge 0\\
\end{cases}
$$

4. 解上述所有约束条件构成的方程组即为$KKT点$：

$$
x^* =
\begin{bmatrix}1 \\
1\end{bmatrix} \\
v = 0 \\
w_1 = 0 \\
w_2 = 0 \\
w_3 = 0 \\


$$

5. 验证$KKT点$是否为最小值：

$$
\nabla^2 f(x) =
\begin{bmatrix}
2&0\\
0&2
\end{bmatrix}
\quad
$$

因为海森矩阵是正定矩阵，且约束条件均是凹函数，则原问题是凸优化，即为最小值。

---

### （3）有约束非凸规划示例

1. 求解问题：

$$
min \quad f(x) = x_1x_2 \\
s.t. \quad x_1^2 + x_2^2 -1 = 0
$$

2. 构建拉格朗日函数，并列出约束条件：

$$
L(x,v) = x_1x_2 - v(x_1^2 + x_2^2 -1)
$$

3. 列出所有约束条件：

> 对于等式约束，没有互补松弛约束和决策变量约束

$$
\begin{cases}
x_2 - 2x_1v = 0 \\
x_1 - 2x_2v = 0 \\
x_1^2 + x_2^2 -1 = 0 \\
\end{cases}
$$

4. 此时解得四个$KKT$点：

$$
x^{(1)} = (x_1,x_2,v) = [\frac{\sqrt{2}}{2},\frac{\sqrt{2}}{2},\frac{1}{2}] \\
$$

$$

x^{(2)} = (x_1,x_2,v) = [-\frac{\sqrt{2}}{2},-\frac{\sqrt{2}}{2},\frac{1}{2}] \\
$$

$$

x^{(3)} = (x_1,x_2,v) = [-\frac{\sqrt{2}}{2},\frac{\sqrt{2}}{2},-\frac{1}{2}] \\
$$

$$

x^{(4)} = (x_1,x_2,v) = [\frac{\sqrt{2}}{2},-\frac{\sqrt{2}}{2},-\frac{1}{2}] \\
$$

5. 通过二阶信息判断$KKT点$的性质,其中$d$表示可行方向$d = [d_1,d_2]$：

对于$x^{(1)}$和$x^{(2)}$，计算有：

$$
\begin{cases}
d = [d_1,d_2] \\
∇g(x^∗)^Td=0 \\
\end{cases}
\Rightarrow d_1 = -d_2
$$

$$
d^T\nabla_x^2L(x^*,v^*)d = -4d_1^2 \lt 0
$$

对于$x^{(3)}$和$x^{(4)}$，计算有：

$$
\begin{cases}
d = [d_1,d_2] \\
∇g(x^∗)^Td=0 \\
\end{cases}
\Rightarrow d_1 = d_2
$$

$$
d^T\nabla_x^2L(x^*,v^*)d = 4d_1^2 \gt 0
$$

所以$x^{(3)}$和$x^{(4)}$最优值。

## 四、拉格朗日对偶

### （1）一般流程

1. 构建拉格朗日函数
2. 构造对偶函数
3. 求解对偶问题
4. 根据对偶问题求解原问题

### （2）示例

对于原问题：

$$
min \quad x_1^2 + x_2^2 \\
s.t. \quad x_1 + x_2 - 4 \ge 0\\
x_1,x_2 \ge 0
$$

不同于线性规划，决策变量本身的范围需要被定义为`约束集`。

集约束：

$$
x \in D = \{(x_1,x_2)T| x_1 \ge 0,x_2 \gt 0\}
$$

对偶问题：

$$
\theta(w) = inf \{x_1^2 + x_2^2 -w(x_1+x_2-4) | x \in D\} \\
$$

$$
\theta(w) =  inf \{x_1^2 -wx_1 | x_1 \ge 0\}  + inf \{x_2^2 -wx_2 | x_2 \ge 0\}  + 4w
$$

其中：

$$
inf \{x_1^2 -wx_1 | x_1 \ge 0\}  = (x_1- \frac{w}{2})^2 - \frac{w^2}{4} \ge  - \frac{w^2}{4}
$$

$$
inf \{x_2^2 -wx_2 | x_2 \ge 0\}  = (x_2- \frac{w}{2})^2 - \frac{w^2}{4} \ge  - \frac{w^2}{4}
$$

汇总有：

$$
\theta(w) = - \frac{w^2}{2} + 4w
$$

故对偶问题为：

$$
max \quad - \frac{w^2}{2} + 4w \\
w \ge 0
$$

---

## 五、 最速下降法

### （1）一般流程

1. 计算梯度
2. 下降方向为负梯度方向
3. 判断梯度的二阶范数是否足够小，是则终止
4. 通过一维精确搜索计算最优步长
5. 计算出下一个目标点

### （2）示例

---

## 六、 牛顿法

### （1）一般流程

1. 计算梯度
2. 梯度的二阶范数是否足够小，是则终止
3. 计算海森矩阵
4. 计算海森矩阵的逆
5. 下降方向为负海森矩阵的逆乘梯度
6. 计算出下一个目标点

### （2）示例

---

## 七、 共轭梯度法

### （1）一般流程

1. 将二阶凸函数表示为标准形式，计算出A
2. 计算梯度，梯度的二阶范数是否足够小，是则终止
3. 下降方向为负梯度方向
4. 根据公式计算步长
5. 计算出下一个目标点
6. 计算梯度，梯度的二阶范数是否足够小，是则终止
7. 下降方向为共轭方向
8. 计算新步长
9. 计算出下一个目标点

### （2）示例

---

## 八、外点罚函数法

### （1）一般流程

1. 构造罚函数
2. 选择初始点
3. 使用最速下降法或牛顿法等求解
4. 逐步增大罚因子$r$
5. 当约束满足精度要求且目标函数变化很小，停止迭代。

### （2）示例

对于问题：

$$
min \quad f(x)  =(x_1-1)^2 + x_2^2 \\
s.t. \quad g(x) = x_2 - 1 \gt 0
$$

定义罚项：

对于不等式约束如下

$$
p(x) = \sigma[max\{0,-g(x)\}]^2 \\
$$

对于等式约束：

$$
p(x) = \sigma [g(x)]^2 \\
$$

带入$g(x)$有：

$$
p(x) =  \sigma[max\{0,1-x_2\}]^2
$$

将罚项处理为分段函数：

$$
p(x) = \begin{cases}
0, \quad x_2 \ge 1 \\
\sigma(x_2 - 1)^2 ,\quad x_2 \lt 1 \\
\end{cases}
$$

定义罚函数：

$$
F(x,\sigma) = \begin{cases}
(x_1-1)^2 + x_2^2, \quad x_2 \ge 1 \\
(x_1-1)^2 + x_2^2 + \sigma(x_2 - 1)^2 ,\quad x_2 \lt 1 \\
\end{cases}
$$

对分段函数求偏导：

$$
\frac{\partial F}{\partial x_1} = 2(x_1 - 1)
$$

$$
\frac{\partial F}{\partial x_2} = \begin{cases}
2x_2, \quad x_2 \ge 1 \\
2x_2 + 2\sigma(x_2 - 1) ,\quad x_2 \lt 1 \\
\end{cases}
$$

令两个偏导数都等于零，并让罚项$\sigma$趋向于正无穷，计算极限有：

$$
\bar{x}_\sigma = (1,1)^T
$$

最优解就是$(1,1)^T$

---

## 九、 内点罚函数法

### （1）一般流程

1. 构造内点函数
2. 初始点
3. 使用最速下降法或牛顿法等求解
4. 逐步增大$t$
5. 当 t 足够大且梯度或约束误差满足精度要求时停止。

### （2）示例

---

$$
$$
